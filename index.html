<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bottom of the 9th - Taiwan Meme Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --grass: #1b5e20; --dirt: #5d4037; --line: rgba(255,255,255,0.7); --gold: #ffd700; --red: #ff5252; --blue: #2196f3; --dark: #0f0f0f; }
        body { background: var(--dark); color: white; font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 10px; overflow-x: hidden; touch-action: manipulation; user-select: none; }
        
        .container { max-width: 500px; margin: 0 auto; position: relative; padding-bottom: 30px; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .pool-box { font-size: 0.9em; color: var(--gold); border: 1px solid var(--gold); padding: 5px 12px; border-radius: 20px; background: rgba(255, 215, 0, 0.1); font-weight: bold; }
        .right-tools { display: flex; gap: 10px; align-items: center; }
        
        .connect-btn { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer; transition: 0.2s; }
        .connect-btn.connected { background: #1b5e20; border-color: #4caf50; color: #fff; }
        
        .lang-switch { cursor: pointer; font-size: 1.2em; border: 1px solid #555; padding: 2px 8px; border-radius: 5px; background: #222; }

        .balance-row { text-align: right; font-size: 0.85em; color: #aaa; margin-bottom: 10px; padding-right: 5px; }
        .balance-val { color: #fff; font-weight: bold; font-size: 1.1em; }

        .scoreboard { display: grid; grid-template-columns: 1fr 1fr 1.2fr 1.5fr; background: #000; border: 3px solid #444; border-radius: 8px; padding: 10px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-family: 'Courier New', monospace; }
        .score-box { text-align: center; border-right: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
        .score-box:last-child { border: none; }
        .label { font-size: 0.65em; color: #888; margin-bottom: 2px; letter-spacing: 1px; }
        .value { font-size: 1.8em; font-weight: bold; color: #fff; }
        .home-score { color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .outs { color: var(--red); letter-spacing: 4px; }
        
        .commentary-box { background: #222; border-left: 5px solid var(--gold); color: #ddd; font-size: 1em; padding: 15px; margin-bottom: 20px; text-align: left; min-height: 60px; display: flex; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border-radius: 0 8px 8px 0; transition: border-color 0.3s ease; line-height: 1.4; }
        .commentator-name { color: #888; font-weight: bold; margin-right: 10px; font-size: 0.9em; white-space: nowrap; }
        #commentaryText { transition: opacity 0.3s ease-in-out; }
        
        .field-container { width: 100%; aspect-ratio: 1/1; position: relative; margin-bottom: 20px; }
        .field { width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, #388e3c 0%, #1b5e20 90%); border-radius: 12px 12px 50% 50%; position: relative; overflow: hidden; border: 5px solid #444; box-shadow: inset 0 0 80px rgba(0,0,0,0.8); }
        .infield { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 72%; height: 72%; background: var(--dirt); border-radius: 50% 50% 0 0; border-top: 2px dashed rgba(255,255,255,0.4); }
        .diamond-wrap { position: absolute; bottom: 12%; left: 50%; width: 42%; height: 42%; transform: translateX(-50%) rotate(45deg); border: 2px solid var(--line); box-sizing: border-box; z-index: 5; }
        .base { width: 26px; height: 26px; background: #ddd; position: absolute; transform: translate(-50%, -50%) rotate(-45deg); box-shadow: 3px 3px 6px rgba(0,0,0,0.6); transition: 0.3s; z-index: 10; border: 1px solid #999; }
        .base.active { background: var(--gold); box-shadow: 0 0 20px var(--gold); border: 2px solid #fff; }
        #base1 { top: 0; right: 0; } #base2 { top: 0; left: 0; } #base3 { bottom: 0; left: 0; } #baseH { bottom: 0; right: 0; background: #fff; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); border-radius: 0; }
        
        .runner-dot { position: absolute; width: 18px; height: 18px; background: var(--gold); border: 2px solid white; border-radius: 50%; z-index: 20; box-shadow: 0 0 10px var(--gold); top: 0; left: 0; margin-top: -9px; margin-left: -9px; animation: runBase 0.6s linear forwards; }
        @keyframes runBase { from { top: var(--startY); left: var(--startX); } to { top: var(--endY); left: var(--endX); } }
        
        .pitch-ball { width: 12px; height: 12px; background: white; border-radius: 50%; position: absolute; display: none; z-index: 15; left: 50%; bottom: 34%; transform: translateX(-50%); box-shadow: 0 0 5px white; }
        
        .message { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; font-weight: 900; color: white; text-shadow: 0 5px 0 #000, 0 0 30px rgba(255,255,255,1); display: none; z-index: 30; white-space: nowrap; pointer-events: none; font-style: italic; }
        .hit-ani { animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
        
        .controls-label { font-size: 0.85em; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 5px; }
        .btn-action { border: none; height: 55px; color: white; font-size: 0.95em; border-radius: 12px; cursor: pointer; font-weight: bold; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: 0.1s; }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-action:disabled { background: #333 !important; color: #555; transform: translateY(4px); box-shadow: none; cursor: default; }
        .btn-power { background: linear-gradient(to bottom, #d32f2f, #b71c1c); } 
        .btn-bunt { background: linear-gradient(to bottom, #1976d2, #0d47a1); } 
        .btn-take { background: linear-gradient(to bottom, #388e3c, #1b5e20); }
        .btn-sub { font-size: 0.7em; opacity: 0.8; font-weight: normal; margin-top: 2px; }
        
        .start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 10px; backdrop-filter: blur(3px); }
        .start-btn { background: linear-gradient(to bottom, #ff9800, #f57c00); font-size: 1.8em; padding: 15px 40px; border-radius: 50px; color: #fff; border: 4px solid #fff; animation: pulse 1.5s infinite; cursor: pointer; font-weight: 900; text-transform: uppercase; box-shadow: 0 0 25px rgba(255, 152, 0, 0.6); margin-top: 15px; }
        .start-btn:disabled { animation: none; background: #555; border-color: #777; box-shadow: none; cursor: not-allowed; opacity: 0.7; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .status-bar { background: #222; color: #aaa; font-size: 0.95em; padding: 8px; margin-bottom: 15px; border-radius: 6px; min-height: 24px; font-weight: bold; letter-spacing: 0.5px; }
        
        .payout-table { margin-top: 20px; width: 100%; font-size: 0.9em; color: #999; border-collapse: collapse; background: #1a1a1a; border-radius: 10px; border: 1px solid #333; overflow: hidden; }
        .payout-table td { padding: 10px 12px; border-bottom: 1px solid #333; }
        .payout-table tr:last-child td { border-bottom: none; }
        .highlight { color: var(--gold); font-weight: bold; text-shadow: 0 0 5px rgba(255, 215, 0, 0.2); }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <div class="pool-box">POOL: <span id="jackpot">Loading...</span></div>
        <div class="right-tools">
            <button id="connectBtn" class="connect-btn" onclick="connectWallet()">ğŸ”— Connect Wallet</button>
            <div class="lang-switch" onclick="toggleLang()">ğŸŒ <span id="langIcon">EN</span></div>
        </div>
    </div>

    <div class="balance-row">
        <span id="txtBalance">Balance</span>: <span id="balance" class="balance-val">--</span> CRO
    </div>

    <div class="scoreboard">
        <div class="score-box"> <span class="label">GUEST</span> <span class="value">2</span> </div>
        <div class="score-box"> <span class="label">HOME</span> <span class="value home-score" id="homeScore">0</span> </div>
        <div class="score-box"> <span class="label">INNING</span> <span class="value inning">9â–¼</span> </div>
        <div class="score-box"> <span class="label">OUTS</span> <span class="value outs" id="outs">â—‹â—‹â—‹</span> </div>
    </div>

    <div class="status-bar" id="gameStatus">Waiting...</div>

    <div class="commentary-box">
        <span class="commentator-name" id="casterTitle">Broadcaster:</span>
        <span id="commentaryText">Welcome to the ballpark! Connect wallet to play.</span>
    </div>

    <div class="field-container">
        <div class="start-overlay" id="startScreen">
            <div style="margin-bottom:10px; color:#aaa; font-weight:bold;" id="txtBetAmt">BET: 10 CRO</div>
            
            <button class="start-btn" id="playBtn" onclick="startGame()" disabled>PLAY BALL</button>
            
            <div style="margin-top:20px; font-size:0.8em; color:#ccc;" id="txtRule">Rule: Score > 2 to Win</div>
            <div style="margin-top:5px; font-size:0.7em; color:#666;" id="txtWalletHint">(Please connect wallet first)</div>
        </div>

        <div class="field">
            <div class="infield"></div>
            <div class="mound"></div>
            <div class="pitch-ball" id="pitchBall"></div>
            <div class="message" id="msg">HOME RUN!</div>
        </div>
        <div class="diamond-wrap">
            <div class="base" id="base2"></div>
            <div class="base" id="base1"></div>
            <div class="base" id="base3"></div>
            <div class="base" id="baseH"></div>
        </div>
    </div>

    <div class="controls-label" id="txtStrategy">Batting Strategy</div>
    <div class="controls">
        <button class="btn-action btn-power" id="btnPower" onclick="playTurn('POWER')" disabled>
            <span id="lblPower">Power</span>
        </button>
        <button class="btn-action btn-bunt" id="btnBunt" onclick="playTurn('BUNT')" disabled>
            <span id="lblBunt">Bunt</span>
        </button>
        <button class="btn-action btn-take" id="btnTake" onclick="playTurn('TAKE')" disabled>
            <span id="lblTake">Take</span>
        </button>
    </div>

    <table class="payout-table">
        <tr id="row0"><td>0-1 Runs</td><td style="color:#666;">Loss</td></tr>
        <tr id="row1"><td>2 Runs (Tie)</td><td>Refund</td></tr>
        <tr id="row2"><td>3 Runs</td><td class="highlight">2x Payout</td></tr>
        <tr id="row3"><td>4 Runs</td><td class="highlight" style="color:#ff9800">5x Payout</td></tr>
        <tr id="row4"><td>5+ Runs</td><td class="highlight" style="color:#e040fb">10x Jackpot</td></tr>
    </table>
</div>

<script>
    // ğŸ”¥ åˆç´„è¨­å®š
    const GAME_CONTRACT_ADDRESS = "0xDdDf7eBBcC42d933B1e2A43d5dD43d0BB5a63471"; 
    const BANKROLL_ADDRESS = "0x7A427604Ff8Ce728A60cF5cB247B30C0cE29188B";

    const GAME_ABI = [
        "function play() external payable",
        "event GameResult(address indexed player, uint256 payout, uint256 seed, uint256 finalScore)"
    ];

    let provider, signer, gameContract;
    let userAddress = null;
    let curLang = 'zh'; 

    // æ©Ÿç‡ (HR:1, 3B:3, 2B:10, 1B:29, OUT:57)
    const PROBS = { HR: 1, TRIPLE: 3, DOUBLE: 10, SINGLE: 29, OUT: 57 };
    let currentRandom = BigInt(0);
    
    let outs = 0; let homeScore = 0; let bases = [0, 0, 0]; 
    let isGameActive = false; let isAnimating = false; let currentStrategy = "POWER"; 

    const basePos = { 0: { t: '100%', l: '100%' }, 1: { t: '0%', l: '100%' }, 2: { t: '0%', l: '0%' }, 3: { t: '100%', l: '0%' }, 4: { t: '120%', l: '50%' } };

    // ğŸŒŸ å¤šèªè¨€å­—å…¸ (å«å°ç£ç¶“å…¸é‡‘å¥)
    const TEXT = {
        zh: {
            pool: "ç´¯ç©çæ± ", connect: "é€£çµéŒ¢åŒ…", balance: "é¤˜é¡", bet: "ä¸‹æ³¨: 10 CRO",
            rule: "è¦å‰‡ï¼š9å±€ä¸‹åŠè½å¾Œ2åˆ†ï¼Œé€†è½‰å³æ´¾å½©", walletHint: "(è«‹å…ˆé€£çµéŒ¢åŒ…ä»¥é–‹å§‹)",
            strategy: "é¸æ“‡æ‰“æ“Šç­–ç•¥",
            btnPower: "å…¨åŠ›æ®æ£’", btnBunt: "çŸ­æ‰“/æ”¶æ‰“", btnTake: "è¬¹æ…é¸çƒ",
            caster: "çƒè©•:",
            waiting: "ç­‰å¾…æ¯”è³½é–‹å§‹...",
            intro: "æ¯”è³½å³å°‡é–‹å§‹ï¼è«‹æŒ‰ PLAY BALLï¼",
            payout: ["è¼¸æ‰æœ¬é‡‘", "é€€é‚„æœ¬é‡‘", "2å€ çé‡‘", "5å€ çé‡‘", "10å€ å¤§ç"],
            status: { lose: "è½å¾Œ {s} åˆ†ï¼Œé€†è½‰å§ï¼", tie: "âœ¨ å¹³æ‰‹ï¼ä¸‹ä¸€åˆ†ç›´æ¥è´ï¼", win: "ğŸ† æ¯”è³½çµæŸï¼é€†è½‰å‹ï¼" },
            // ğŸ”¥ å°ç£é„‰æ°‘ & ç¶“å…¸ä¸»æ’­èªéŒ„
            comments: {
                START: ["ä¹å±€ä¸‹åŠï¼Œè½å¾Œå…©åˆ†ï¼é—œéµæ™‚åˆ»ï¼", "æ•™ç·´è‡‰è‰²å¾ˆé›£çœ‹ï¼Œé€™å±€ä¸€å®šè¦å¾—åˆ†ï¼", "é˜¿å¨˜å–‚ï¼ç¾å ´çƒè¿·éƒ½ç«™èµ·ä¾†äº†ï¼"],
                SWING_POWER: ["å¤§æ£’ä¸€æ®ï¼(ç­‰å¾…çµæœ...)", "æƒ³è¦ä¸€æ£’æ‰›åˆ°åœè»Šå ´ï¼", "ç”¨ç›¡åƒå¥¶åŠ›æ°£æ®æ£’ï¼"],
                SWING_BUNT: ["æ“ºå‡ºçŸ­æ£’...(ç­‰å¾…çµæœ)", "çªç„¶æ”¶æ‰“ï¼", "æƒ³è¦é»å€‹å…§é‡å®‰æ‰“ï¼"],
                SWING_TAKE: ["ä»”ç´°é¸çƒ...(ç­‰å¾…çµæœ)", "é€™çƒå¾ˆæ¥è¿‘...", "å¿ä½ä¸å‡ºæ£’ï¼"],
                
                // ç¶“å…¸åè¨€å€
                OUT: ["ä¾¿ç•¶ä¾¿ç•¶ï¼æ®æ£’è½ç©ºï¼", "ä¸å¯èƒ½ï¼å²³æ±è¯ç«Ÿç„¶...æ’²æ¥åˆ°äº†ï¼", "å…©å€‹å­—ï¼Œå¤§ä¸­è¨ˆï¼", "æ‰“å¾—è»Ÿè¶´è¶´ï¼Œåˆºæ®ºå‡ºå±€ï¼"],
                
                DP: ["ä¸­äº†æ»¿å£˜è¨ˆï¼ç“¦è§£äº†ï¼", "å“å‘€ï¼é›™æ®ºæ‰“ï¼æœ€å£çš„çµæœï¼", "6-4-3 é›™æ®ºï¼æ”»å‹¢ç“¦è§£ï¼"],
                
                BB: ["é¸å¾—å¥½ï¼å››å£çƒä¿é€ï¼", "æŠ•æ‰‹ç…®ç²¥äº†ï¼Œä¿é€ä¸Šå£˜ï¼"],
                HBP: ["è§¸èº«çƒï¼å¥½ç—›ï¼", "ç ¸åœ¨èº«ä¸Šï¼ä¿é€ä¸Šä¸€å£˜ï¼"],
                HIT: ["å…§é‡äº‚æˆä¸€é‹ç²¥äº†ï¼", "å®‰æ‰“å•¦ï¼ç©¿è¶Šå®‰æ‰“ï¼", "æ°´å–”ï¼é€™çƒæ‰“å¾—éå¸¸çµå¯¦ï¼"],
                
                DOUBLE: ["æ·±é çš„é•·æ‰“ï¼äºŒå£˜å®‰æ‰“ï¼", "çƒæ»¾åˆ°å…¨å£˜æ‰“ç‰†é‚Šï¼è·‘è€…è¡å•Šï¼"],
                TRIPLE: ["ä¸‰å£˜å®‰æ‰“ï¼è·‘è€…è·‘å¾—è·Ÿé£›çš„ä¸€æ¨£ï¼", "çƒåœ¨è§’è½è™•ç†å¾ˆä¹…ï¼ä¸‰å£˜å®‰æ‰“ï¼"],
                
                HR: ["é€™åªæ˜¯ä¸€å€‹é£›çƒ......é˜¿å¨˜å–‚ï¼é£›å‡ºå»äº†ï¼", "è®Šäº†å¿ƒçš„å¥³æœ‹å‹ï¼å›ä¸ä¾†äº†ï¼ç´…ä¸è®“ï¼", "ä¾†å›‰ï½ã„›ã„›ã„›ã„›ï½å¾æ±äº¬æ‰“åˆ°åŒ—äº¬ï¼", "çœŸçš„æœ‰å¤©å¤©éå¹´çš„å•¦ï¼å…¨å£˜æ‰“ï¼"],
                
                HR_BUNT: ["å‡é»çœŸæ‰“ï¼æŠ•æ‰‹è¢«é¨™äº†ï¼å‡ºå»äº†ï¼", "é€™é¡†å¤±æŠ•çƒè¢«é€®ä¸­ï¼å…¨å£˜æ‰“ï¼"],
                HR_TAKE: ["çƒå¤ªç”œäº†å¿ä¸ä½ï¼è½Ÿå‡ºç‰†å¤–ï¼", "æ•™ç·´å«ä½ ç­‰çƒä½ é‚„æ‰“ï¼Ÿä½†çµæœæ˜¯å…¨å£˜æ‰“ï¼"],
                
                TIE: ["è¿½å¹³äº†ï¼æ­»è£¡é€ƒç”Ÿï¼", "ç¾åœ¨é›™æ–¹å›åˆ°åŸé»ï¼"],
                WIN: ["å†è¦‹å®‰æ‰“ï¼æ¯”è³½çµæŸï¼ä»Šæ™šåƒé›ï¼", "é€†è½‰å‹ï¼æˆ‘å€‘è´äº†ï¼"],
                LOSE: ["é€™å ´æ¯”è³½...åƒé‹è²¼äº†ã€‚", "ç•™ä¸‹æ®˜å£˜ï¼Œè¼¸æ‰äº†æ¯”è³½ã€‚"]
            }
        },
        en: {
            pool: "PRIZE POOL", connect: "Connect Wallet", balance: "Balance", bet: "BET: 10 CRO",
            rule: "Rule: Bottom 9th, Down by 2. Win to Earn.", walletHint: "(Connect wallet to play)",
            strategy: "Batting Strategy",
            btnPower: "Power Swing", btnBunt: "Bunt/Contact", btnTake: "Take Pitch",
            caster: "Broadcaster:",
            waiting: "Waiting for game...",
            intro: "Welcome to the ballpark! Click PLAY BALL!",
            payout: ["Loss", "Refund (Push)", "2x Payout", "5x Payout", "10x Jackpot"],
            status: { lose: "Trailing by {s}, Rally time!", tie: "âœ¨ TIE GAME! Next run wins!", win: "ğŸ† WALK-OFF WIN!" },
            // MLB Style
            comments: {
                START: ["Bottom of the 9th, down by 2. Rally caps on!", "Last chance for the home team!", "The crowd is on their feet!"],
                SWING_POWER: ["Swinging for the fences!", "He's hacking at that one!", "Power swing!"],
                SWING_BUNT: ["Squaring around to bunt...", "Showing bunt...", "Contact swing!"],
                SWING_TAKE: ["Taking all the way...", "Watching it closely...", "Waiting for his pitch..."],
                OUT: ["Strike three! He got him looking!", "Can of corn! Easy out.", "Ground ball, routine play."],
                DP: ["Oh no! Twin killing! Double Play!", "6-4-3! Pitcher's best friend!"],
                BB: ["Ball four! Take your base.", "Good eye! That's a walk."],
                HBP: ["Ouch! Hit by pitch.", "Plunked him! Take first base."],
                HIT: ["Base hit! Through the infield!", "Line drive! A frozen rope!"],
                DOUBLE: ["Gapped it! Going for two!", "Off the wall! Stand-up double!"],
                TRIPLE: ["Triple! He's flying around the bases!", "Down the line! Going for three!"],
                HR: ["Going, Going, GONE! Goodbye!", "Santa Maria! That ball is crushed!", "Upper deck! WALK-OFF HOMER!"],
                HR_BUNT: ["Fake bunt! He hammers the hanger! GONE!", "He shows bunt but blasts it deep! HOME RUN!"],
                HR_TAKE: ["Green light 3-0? He swings and CRUSHES it!", "He couldn't resist that cookie! HOME RUN!"],
                TIE: ["TIE GAME! Brand new ballgame!", "He tied it up!"],
                WIN: ["WALK-OFF WINNER! BALLGAME OVER!", "The crowd goes wild! We win!"],
                LOSE: ["Strike three! Ballgame over.", "The rally falls short. Game over."]
            }
        }
    };

    function toggleLang() {
        curLang = (curLang === 'zh') ? 'en' : 'zh';
        document.getElementById('langIcon').innerText = (curLang === 'zh') ? 'ç¹ä¸­' : 'EN';
        refreshText();
    }

    function refreshText() {
        const t = TEXT[curLang];
        document.getElementById('jackpot').previousSibling.textContent = t.pool + ": ";
        document.getElementById('connectBtn').innerText = userAddress ? (userAddress.slice(0,6)+'...'+userAddress.slice(-4)) : ("ğŸ”— " + t.connect);
        document.getElementById('txtBalance').innerText = t.balance;
        document.getElementById('txtBetAmt').innerText = t.bet;
        document.getElementById('txtRule').innerText = t.rule;
        document.getElementById('txtWalletHint').innerText = userAddress ? "" : t.walletHint;
        document.getElementById('txtStrategy').innerText = t.strategy;
        
        document.getElementById('btnPower').innerHTML = `<span>${t.btnPower}</span>`;
        document.getElementById('btnBunt').innerHTML = `<span>${t.btnBunt}</span>`;
        document.getElementById('btnTake').innerHTML = `<span>${t.btnTake}</span>`;

        document.getElementById('casterTitle').innerText = t.caster;
        document.getElementById('gameStatus').innerText = isGameActive ? document.getElementById('gameStatus').innerText : t.waiting;
        
        const rows = document.querySelectorAll('.payout-table tr td:nth-child(2)');
        t.payout.forEach((txt, i) => { if(rows[i]) rows[i].innerText = txt; });

        if(!isGameActive) document.getElementById('commentaryText').innerText = t.intro;
    }

    async function connectWallet() {
        if (!window.ethereum) return alert("Please install MetaMask / DeFi Wallet");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            gameContract = new ethers.Contract(GAME_CONTRACT_ADDRESS, GAME_ABI, signer);
            
            document.getElementById('connectBtn').classList.add('connected');
            document.getElementById('playBtn').disabled = false;
            document.getElementById('txtWalletHint').style.display = 'none';
            
            refreshText(); 
            updateInfo();
        } catch (e) {
            console.error(e);
            alert("Connect Failed");
        }
    }

    async function updateInfo() {
        if(!provider || !userAddress) return;
        const bal = await provider.getBalance(userAddress);
        document.getElementById('balance').innerText = parseFloat(ethers.formatEther(bal)).toFixed(2);
        
        const poolBal = await provider.getBalance(BANKROLL_ADDRESS);
        document.getElementById('jackpot').innerText = Math.floor(parseFloat(ethers.formatEther(poolBal))).toLocaleString();
    }

    async function startGame() {
        if(!gameContract) {
            alert("Please connect wallet first!");
            return;
        }

        document.getElementById('startScreen').innerHTML = "<div style='color:white; font-size:1.2em;'>Processing...<br><span style='font-size:0.8em; color:#aaa'>Confirm transaction in wallet</span></div>";
        
        try {
            const tx = await gameContract.play({ value: ethers.parseEther("10") });
            document.getElementById('startScreen').innerHTML = "<div style='color:white; font-size:1.2em;'>âš¾ Pitching...<br><span style='font-size:0.8em; color:#aaa'>Waiting for block confirmation</span></div>";
            
            const receipt = await tx.wait();
            
            let foundSeed = null;
            receipt.logs.forEach(log => {
                try {
                    const parsed = gameContract.interface.parseLog(log);
                    if(parsed.name === "GameResult") foundSeed = parsed.args.seed;
                } catch(e){}
            });

            if(!foundSeed) throw new Error("No Seed Found");
            currentRandom = foundSeed; 
            
            outs = 0; homeScore = 0; bases = [0, 0, 0];
            isGameActive = true;
            document.getElementById('startScreen').style.display = 'none';
            
            setTimeout(() => {
                const t = TEXT[curLang];
                document.getElementById('startScreen').innerHTML = `
                    <div style="margin-bottom:10px; color:#aaa; font-weight:bold;" id="txtBetAmt">${t.bet}</div>
                    <button class="start-btn" id="playBtn" onclick="startGame()">PLAY BALL</button>
                    <div style="margin-top:20px; font-size:0.8em; color:#ccc;" id="txtRule">${t.rule}</div>
                `;
            }, 1000);

            enableBtns(true);
            updateUI();
            speak("START");

        } catch (e) {
            console.error(e);
            alert("Error: " + (e.reason || e.message));
            const t = TEXT[curLang];
            document.getElementById('startScreen').innerHTML = `
                <div style="margin-bottom:10px; color:#aaa; font-weight:bold;">${t.bet}</div>
                <button class="start-btn" id="playBtn" onclick="startGame()">PLAY BALL</button>
                <div style="margin-top:20px; font-size:0.8em; color:#ccc;">Transaction Cancelled</div>
            `;
        }
    }

    function nextRandom() {
        const newHash = ethers.solidityPackedKeccak256(["uint256"], [currentRandom]);
        currentRandom = BigInt(newHash);
        return Number(currentRandom % 100n);
    }

    function enableBtns(enable) {
        document.getElementById('btnPower').disabled = !enable;
        document.getElementById('btnBunt').disabled = !enable;
        document.getElementById('btnTake').disabled = !enable;
    }

    function playTurn(strategy) {
        if (!isGameActive || isAnimating) return;
        isAnimating = true; enableBtns(false); currentStrategy = strategy;

        if(strategy === 'POWER') speak("SWING_POWER");
        else if(strategy === 'BUNT') speak("SWING_BUNT");
        else speak("SWING_TAKE");

        const ball = document.getElementById('pitchBall');
        ball.style.display = 'block'; ball.style.bottom = '34%'; ball.style.transition = 'none';
        void ball.offsetWidth;
        ball.style.transition = 'bottom 0.6s linear'; ball.style.bottom = '10%';

        setTimeout(() => {
            ball.style.display = 'none';
            handleResult(getResult());
        }, 800);
    }

    function getResult() {
        const r = nextRandom();
        let outcome = 'OUT'; let c = 0;
        if(r < (c += PROBS.HR)) outcome = 'HR';
        else if(r < (c += PROBS.TRIPLE)) outcome = '3B';
        else if(r < (c += PROBS.DOUBLE)) outcome = '2B';
        else if(r < (c += PROBS.SINGLE)) outcome = '1B';
        else outcome = 'OUT';

        if (outcome === 'OUT' && bases[0] === 1 && outs < 2) {
             if (nextRandom() < 20) return 'DP'; 
        }
        if (outcome === '1B') {
            const rt = nextRandom();
            if (rt < 15) return 'BB'; if (rt < 20) return 'HBP';
            return '1B'; 
        }
        return outcome;
    }

    function handleResult(type) {
        if (type === 'OUT' || type === 'DP') {
            let addOuts = 1; let text = "OUT!"; let color = "#ff5252";
            if (type === 'DP') { addOuts = 2; text = "DOUBLE PLAY!"; speak("DP"); bases[0] = 0; } 
            else { speak("OUT"); }
            outs += addOuts; showHitText(text, color); updateUI();
            setTimeout(() => {
                isAnimating = false;
                if (outs >= 3) endGame(false); else enableBtns(true);
            }, 1500);
        } else {
            let hitBases = 1, text = "HIT!", color = "#fff";
            if (type === 'BB') { text = "WALK"; speak("BB"); color="#4caf50"; }
            else if (type === 'HBP') { text = "HBP"; speak("HBP"); color="#ff9800"; }
            else if (type === '1B') { text = "HIT"; speak("HIT"); }
            else if (type === '2B') { text="DOUBLE"; hitBases=2; speak("DOUBLE"); color="#4caf50"; }
            else if (type === '3B') { text="TRIPLE"; hitBases=3; speak("TRIPLE"); color="#ffd700"; }
            else if (type === 'HR') { 
                text="HOME RUN"; hitBases=4; color="#e040fb";
                if (currentStrategy === 'BUNT') speak("HR_BUNT");
                else if (currentStrategy === 'TAKE') speak("HR_TAKE");
                else speak("HR");
            }
            showHitText(text, color); advanceRunners(hitBases);
        }
    }

    async function advanceRunners(hitBases) {
        let movers = [];
        if(bases[2]) movers.push({s:3}); if(bases[1]) movers.push({s:2}); if(bases[0]) movers.push({s:1}); movers.push({s:0});
        let runs = 0; let nextBases = [0, 0, 0]; let promises = [];

        movers.forEach(m => {
            let e = m.s + hitBases;
            promises.push(animateRunner(m.s, e));
            if (e > 3) runs++; else nextBases[e-1] = 1;
        });

        await Promise.all(promises);
        bases = nextBases; homeScore += runs; updateUI();
        
        if (homeScore > 2) { speak("WIN"); setTimeout(() => endGame(true), 2000); } 
        else if (homeScore === 2) { speak("TIE"); isAnimating = false; enableBtns(true); } 
        else { isAnimating = false; enableBtns(true); }
    }

    function animateRunner(start, end) {
        return new Promise(resolve => {
            const wrap = document.querySelector('.diamond-wrap');
            const dot = document.createElement('div');
            dot.className = 'runner-dot';
            let tIdx = end > 3 ? 4 : end;
            dot.style.setProperty('--startX', basePos[start].l); dot.style.setProperty('--startY', basePos[start].t);
            dot.style.setProperty('--endX', basePos[tIdx].l); dot.style.setProperty('--endY', basePos[tIdx].t);
            wrap.appendChild(dot); dot.addEventListener('animationend', () => { dot.remove(); resolve(); });
        });
    }

    function speak(key) {
        const t = TEXT[curLang];
        const lines = t.comments[key]; if(!lines) return;
        const text = lines[Math.floor(Math.random() * lines.length)];
        const box = document.getElementById('commentaryText');
        box.style.opacity = 0;
        const boxDiv = document.querySelector('.commentary-box');
        if(key.includes('WIN') || key.includes('HR')) boxDiv.style.borderLeftColor = "#ff5252";
        else if(key === 'TIE' || key === 'BB') boxDiv.style.borderLeftColor = "#4caf50";
        else boxDiv.style.borderLeftColor = "#ffd700";
        setTimeout(() => { box.innerText = text; box.style.opacity = 1; }, 300); 
    }

    function updateUI() {
        const t = TEXT[curLang];
        document.getElementById('homeScore').innerText = homeScore;
        document.getElementById('outs').innerHTML = "â—".repeat(outs > 3 ? 3 : outs) + "<span style='color:#333'>â—‹</span>".repeat(Math.max(0, 3-outs));
        document.getElementById('base1').className = bases[0] ? 'base active' : 'base';
        document.getElementById('base2').className = bases[1] ? 'base active' : 'base';
        document.getElementById('base3').className = bases[2] ? 'base active' : 'base';
        
        const status = document.getElementById('gameStatus');
        if(homeScore < 2) { 
            status.style.background = "#222"; status.style.color="#aaa"; 
            status.innerText = t.status.lose.replace("{s}", 2-homeScore); 
        } 
        else if(homeScore === 2) { 
            status.style.background = "#1b5e20"; status.style.color="#fff"; 
            status.innerText = t.status.tie; 
        } 
        else { 
            status.style.background = "linear-gradient(90deg, #ffd700, #ff9800)"; status.style.color="#000"; 
            status.innerText = t.status.win; 
        }
        
        document.querySelectorAll('.payout-table tr').forEach(tr => tr.style.background = "");
        if(homeScore >= 2) {
             let idx = homeScore >= 5 ? 4 : (homeScore >= 4 ? 3 : (homeScore >= 3 ? 2 : 1));
             let rows = document.querySelectorAll('.payout-table tr');
             if(rows[idx]) rows[idx].style.background = "rgba(255, 215, 0, 0.2)";
        }
    }

    function showHitText(text, color) {
        const msg = document.getElementById('msg');
        msg.innerText = text; msg.style.color = color;
        msg.style.display = 'block';
        msg.classList.remove('hit-ani');
        void msg.offsetWidth;
        msg.classList.add('hit-ani');
    }

    function endGame(isWin) {
        isGameActive = false;
        let msg = "";
        const t = TEXT[curLang];
        
        if (!isWin) {
            if (homeScore === 2) { speak("TIE"); msg = t.payout[1]; } 
            else { speak("LOSE"); msg = t.payout[0]; }
        } else {
            speak("WIN");
            let m = 2; if(homeScore === 4) m = 5; if(homeScore >= 5) m = 10;
            msg = (curLang === 'zh') ? `è´å¾— ${m}å€ çé‡‘ï¼` : `You Won ${m}x Payout!`;
        }
        setTimeout(() => {
            alert(msg);
            updateInfo(); 
            document.getElementById('startScreen').style.display = 'flex';
        }, 500);
    }
    
    // åˆå§‹åŒ–èªè¨€
    toggleLang();
</script>

</body>
</html>
